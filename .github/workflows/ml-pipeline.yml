name: ML Training and Deployment Pipeline

on:
  # Ğ¢Ñ€Ğ¸Ğ³ĞµÑ€ Ğ½Ğ° push Ğ´Ğ¾ main
  push:
    branches:
      - main
  
  # Ğ¢Ñ€Ğ¸Ğ³ĞµÑ€ Ğ½Ğ° pull request
  pull_request:
    branches:
      - main
  
  # Ğ ÑƒÑ‡Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº
  workflow_dispatch:
    inputs:
      epochs:
        description: 'Number of training epochs'
        required: false
        default: '3'
      
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===============================================
  # JOB 1: Ğ¢Ñ€ĞµĞ½ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¼Ğ¾Ğ´ĞµĞ»Ñ– Ğ² Docker ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ–
  # ===============================================
  train-model:
    name: Train ML Model
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ—ï¸ Build training Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          tags: training-image:latest
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ğŸ“ Run model training in container
        run: |
          mkdir -p models training_logs
          docker run --name trainer \
            -v ${{ github.workspace }}/models:/app/models \
            -v ${{ github.workspace }}/training_logs:/app/logs \
            training-image:latest \
            python src/train_model.py --epochs ${{ github.event.inputs.epochs || '3' }}
      
      - name: ğŸ“Š Extract training metrics
        run: |
          # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ JSON Ğ· Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ°Ğ¼Ğ¸
          cat > training_metrics.json << 'EOF'
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "epochs": "${{ github.event.inputs.epochs || '3' }}",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}"
          }
          EOF
      
      - name: ğŸ“¦ Upload trained model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: |
            models/*.pth
            models/*.pt
          retention-days: 30
      
      - name: ğŸ“Š Upload training metrics
        uses: actions/upload-artifact@v4
        with:
          name: training-metrics
          path: |
            training_metrics.json
            training_logs/**
          retention-days: 30
  
  # ===============================================
  # JOB 2: Ğ¢ĞµÑÑ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ½Ğ°Ğ²Ñ‡ĞµĞ½Ğ¾Ñ— Ğ¼Ğ¾Ğ´ĞµĞ»Ñ–
  # ===============================================
  test-model:
    name: Test Model Quality
    runs-on: ubuntu-latest
    needs: train-model
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: ğŸ“¦ Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: models/
      
      - name: ğŸ“š Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ§ª Run model tests
        run: |
          python src/test_model.py --model models/best_model_simple.pth
      
      - name: âœ… Validate model performance
        run: |
          # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¼Ñ–Ğ½Ñ–Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ñ— Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ÑÑ‚Ñ–
          python -c "
          import json
          # Ğ¢ÑƒÑ‚ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ»Ğ¾Ğ³Ñ–ĞºÑƒ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº
          print('Model validation passed!')
          "
  
  # ===============================================
  # JOB 3: ĞŸĞ¾Ğ±ÑƒĞ´Ğ¾Ğ²Ğ° Ñ‚Ğ° Ğ¿ÑƒĞ±Ğ»Ñ–ĞºĞ°Ñ†Ñ–Ñ inference Ğ¾Ğ±Ñ€Ğ°Ğ·Ñƒ
  # ===============================================
  build-and-push-inference:
    name: Build and Push Inference Image
    runs-on: ubuntu-latest
    needs: test-model
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ“¦ Download trained model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: models/
      
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=sha
            latest
      
      - name: ğŸ—ï¸ Build and push inference image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: production
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: ğŸ“ Generate deployment report
        run: |
          cat > deployment_report.md << 'EOF'
          # ğŸš€ Deployment Report
          
          **Date**: $(date -u +%Y-%m-%d)
          **Commit**: ${{ github.sha }}
          **Branch**: ${{ github.ref_name }}
          **Actor**: ${{ github.actor }}
          
          ## Docker Image
          - **Registry**: ${{ env.REGISTRY }}
          - **Image**: ${{ env.IMAGE_NAME }}
          - **Tags**: ${{ steps.meta.outputs.tags }}
          
          ## Status
          âœ… Build successful
          âœ… Model trained and tested
          âœ… Image pushed to registry
          EOF
      
      - name: ğŸ“„ Upload deployment report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment_report.md
          retention-days: 90
  
  # ===============================================
  # JOB 4: Benchmark Ñ‚Ğ° Performance Testing
  # ===============================================
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    needs: build-and-push-inference
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Pull inference image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
      
      - name: ğŸš€ Run inference container
        run: |
          docker run -d --name inference-api \
            -p 8000:5000 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
      
      - name: â±ï¸ Measure latency
        run: |
          # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ API Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒÑÑ
          sleep 10
          
          # Ğ’Ğ¸Ğ¼Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ğ»Ğ°Ñ‚ĞµĞ½Ñ‚Ğ½Ñ–ÑÑ‚ÑŒ
          for i in {1..10}; do
            curl -w "@curl-format.txt" -o /dev/null -s \
              -X POST http://localhost:8000/predict_text \
              -H "Content-Type: application/json" \
              -d '{"text":"benchmark test"}'
          done > latency_results.txt
      
      - name: ğŸ“Š Save benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: latency_results.txt
          retention-days: 30
