"""
–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ –Ω–µ–π—Ä–æ–Ω–Ω–æ—ó –º–µ—Ä–µ–∂—ñ –¥–ª—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –≥–æ–ª–æ—Å–æ–≤–∏—Ö –∫–æ–º–∞–Ω–¥
–ü—Ä–æ—Å—Ç–∞ CNN –¥–ª—è –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º
"""

import torch
import torch.nn as nn
import torch.nn.functional as F

class SimpleCNN(nn.Module):
    """
    –ü—Ä–æ—Å—Ç–∞ Convolutional Neural Network –¥–ª—è –∞—É–¥—ñ–æ –∫–ª–∞—Å–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
    
    –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞:
    Input: [batch, 1, 64, 32] - –º–µ–ª-—Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–∏
    ‚Üí Conv2D + ReLU + MaxPool (–∑–Ω–∞—Ö–æ–¥–∏–º–æ –±–∞–∑–æ–≤—ñ –ø–∞—Ç–µ—Ä–Ω–∏)
    ‚Üí Conv2D + ReLU + MaxPool (—Å–∫–ª–∞–¥–Ω—ñ—à—ñ –ø–∞—Ç–µ—Ä–Ω–∏) 
    ‚Üí Flatten (–≤–∏–ø—Ä—è–º–ª—è—î–º–æ –≤ –≤–µ–∫—Ç–æ—Ä)
    ‚Üí Fully Connected (–ø—Ä–∏–π–º–∞—î–º–æ —Ä—ñ—à–µ–Ω–Ω—è)
    ‚Üí Output: [batch, 4] - –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ –∫–ª–∞—Å—ñ–≤
    """
    
    def __init__(self, num_classes=4):
        super(SimpleCNN, self).__init__()
        
        print("üèóÔ∏è –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ—Å—Ç—É CNN –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É...")
        
        # –ü–µ—Ä—à–∏–π –∑–≥–æ—Ä—Ç–∫–æ–≤–∏–π –±–ª–æ–∫
        # –í—Ö—ñ–¥: [batch, 1, 64, 32]
        self.conv1 = nn.Conv2d(
            in_channels=1,      # 1 –∫–∞–Ω–∞–ª (–º–æ–Ω–æ—Ñ–æ–Ω—ñ—á–Ω–µ –∞—É–¥—ñ–æ)
            out_channels=16,    # 16 —Ñ—ñ–ª—å—Ç—Ä—ñ–≤ (–¥–µ—Ç–µ–∫—Ç–æ—Ä—ñ–≤ –ø–∞—Ç–µ—Ä–Ω—ñ–≤)
            kernel_size=3,      # –†–æ–∑–º—ñ—Ä —Ñ—ñ–ª—å—Ç—Ä–∞ 3x3
            padding=1          # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–æ–∑–º—ñ—Ä –ø—ñ—Å–ª—è –∑–≥–æ—Ä—Ç–∫–∏
        )
        self.pool1 = nn.MaxPool2d(2, 2)  # –ó–º–µ–Ω—à—É—î–º–æ —Ä–æ–∑–º—ñ—Ä –≤ 2 —Ä–∞–∑–∏
        
        # –î—Ä—É–≥–∏–π –∑–≥–æ—Ä—Ç–∫–æ–≤–∏–π –±–ª–æ–∫
        # –ü—ñ—Å–ª—è pool1: [batch, 16, 32, 16] 
        self.conv2 = nn.Conv2d(
            in_channels=16,     # 16 –≤—Ö–æ–¥—ñ–≤ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —à–∞—Ä—É
            out_channels=32,    # 32 –±—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
            kernel_size=3,
            padding=1
        )
        self.pool2 = nn.MaxPool2d(2, 2)  # –©–µ –±—ñ–ª—å—à–µ –∑–º–µ–Ω—à—É—î–º–æ
        
        # –¢—Ä–µ—Ç—ñ–π –∑–≥–æ—Ä—Ç–∫–æ–≤–∏–π –±–ª–æ–∫ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è –∫—Ä–∞—â–æ—ó —Ç–æ—á–Ω–æ—Å—Ç—ñ)
        # –ü—ñ—Å–ª—è pool2: [batch, 32, 16, 8]
        self.conv3 = nn.Conv2d(
            in_channels=32,
            out_channels=64,    # 64 –¥—É–∂–µ —Å–∫–ª–∞–¥–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
            kernel_size=3,
            padding=1
        )
        self.pool3 = nn.MaxPool2d(2, 2)
        
        # –ü—ñ—Å–ª—è –≤—Å—ñ—Ö –∑–≥–æ—Ä—Ç–æ–∫ —ñ pooling: [batch, 64, 8, 4]
        # –ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä: 64 * 8 * 4 = 2048
        
        # –ü–æ–≤–Ω–æ–∑–≤'—è–∑–Ω—ñ —à–∞—Ä–∏ (–ø—Ä–∏–π–º–∞—é—Ç—å —Ä—ñ—à–µ–Ω–Ω—è)
        self.fc1 = nn.Linear(64 * 8 * 4, 128)  # 2048 ‚Üí 128 –Ω–µ–π—Ä–æ–Ω—ñ–≤
        self.dropout = nn.Dropout(0.5)          # –ó–∞–ø–æ–±—ñ–≥–∞—î –ø–µ—Ä–µ–Ω–∞–≤—á–∞–Ω–Ω—é
        self.fc2 = nn.Linear(128, num_classes)  # 128 ‚Üí 4 –∫–ª–∞—Å–∏
        
        print("‚úÖ –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞:")
        print("   üîç Conv1: 1‚Üí16 –∫–∞–Ω–∞–ª—ñ–≤, —Ñ—ñ–ª—å—Ç—Ä 3x3")
        print("   üîç Conv2: 16‚Üí32 –∫–∞–Ω–∞–ª—ñ–≤, —Ñ—ñ–ª—å—Ç—Ä 3x3") 
        print("   üîç Conv3: 32‚Üí64 –∫–∞–Ω–∞–ª—ñ–≤, —Ñ—ñ–ª—å—Ç—Ä 3x3")
        print("   üß† FC1: 2048‚Üí128 –Ω–µ–π—Ä–æ–Ω—ñ–≤")
        print("   üéØ FC2: 128‚Üí4 –∫–ª–∞—Å–∏ (yes, no, up, down)")
        
    def forward(self, x):
        """
        –ü—Ä—è–º–∏–π –ø—Ä–æ—Ö—ñ–¥ —á–µ—Ä–µ–∑ –º–µ—Ä–µ–∂—É
        
        Args:
            x: [batch_size, 1, 64, 32] - –≤—Ö—ñ–¥–Ω—ñ —Å–ø–µ–∫—Ç—Ä–æ–≥—Ä–∞–º–∏
            
        Returns:
            output: [batch_size, 4] - –ª–æ–≥—ñ—Ç–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–ª–∞—Å—É
        """
        
        # –ü–µ—Ä—à–∏–π –∑–≥–æ—Ä—Ç–∫–æ–≤–∏–π –±–ª–æ–∫
        x = self.conv1(x)           # [batch, 1, 64, 32] ‚Üí [batch, 16, 64, 32]
        x = F.relu(x)               # –ê–∫—Ç–∏–≤–∞—Ü—ñ—è ReLU
        x = self.pool1(x)           # [batch, 16, 64, 32] ‚Üí [batch, 16, 32, 16]
        
        # –î—Ä—É–≥–∏–π –∑–≥–æ—Ä—Ç–∫–æ–≤–∏–π –±–ª–æ–∫  
        x = self.conv2(x)           # [batch, 16, 32, 16] ‚Üí [batch, 32, 32, 16]
        x = F.relu(x)
        x = self.pool2(x)           # [batch, 32, 32, 16] ‚Üí [batch, 32, 16, 8]
        
        # –¢—Ä–µ—Ç—ñ–π –∑–≥–æ—Ä—Ç–∫–æ–≤–∏–π –±–ª–æ–∫
        x = self.conv3(x)           # [batch, 32, 16, 8] ‚Üí [batch, 64, 16, 8] 
        x = F.relu(x)
        x = self.pool3(x)           # [batch, 64, 16, 8] ‚Üí [batch, 64, 8, 4]
        
        # –í–∏–ø—Ä—è–º–ª—è—î–º–æ –≤ –≤–µ–∫—Ç–æ—Ä –¥–ª—è –ø–æ–≤–Ω–æ–∑–≤'—è–∑–Ω–∏—Ö —à–∞—Ä—ñ–≤
        x = x.view(x.size(0), -1)   # [batch, 64, 8, 4] ‚Üí [batch, 2048]
        
        # –ü–æ–≤–Ω–æ–∑–≤'—è–∑–Ω—ñ —à–∞—Ä–∏
        x = self.fc1(x)             # [batch, 2048] ‚Üí [batch, 128]
        x = F.relu(x)
        x = self.dropout(x)         # –í–∏–ø–∞–¥–∫–æ–≤–æ "–≤–∏–º–∏–∫–∞—î–º–æ" –¥–µ—è–∫—ñ –Ω–µ–π—Ä–æ–Ω–∏
        x = self.fc2(x)             # [batch, 128] ‚Üí [batch, 4]
        
        return x

class EvenSimplerCNN(nn.Module):
    """
    –©–µ –ø—Ä–æ—Å—Ç—ñ—à–∞ –≤–µ—Ä—Å—ñ—è –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
    –ú–µ–Ω—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ = —à–≤–∏–¥—à–µ –Ω–∞–≤—á–∞–Ω–Ω—è
    """
    
    def __init__(self, num_classes=4):
        super(EvenSimplerCNN, self).__init__()
        
        print("üèóÔ∏è –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ø—Ä–æ—â–µ–Ω—É CNN...")
        
        # –¢—ñ–ª—å–∫–∏ –¥–≤–∞ –∑–≥–æ—Ä—Ç–∫–æ–≤—ñ —à–∞—Ä–∏
        self.conv1 = nn.Conv2d(1, 16, 5, padding=2)    # –ë—ñ–ª—å—à–∏–π —Ñ—ñ–ª—å—Ç—Ä 5x5
        self.pool1 = nn.MaxPool2d(4, 4)                # –ë—ñ–ª—å—à–µ –∑–º–µ–Ω—à–µ–Ω–Ω—è
        
        self.conv2 = nn.Conv2d(16, 32, 3, padding=1)
        self.pool2 = nn.MaxPool2d(4, 4)
        
        # –ü—ñ—Å–ª—è –∑–≥–æ—Ä—Ç–æ–∫: [batch, 32, 4, 2] = 256 –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤
        self.fc1 = nn.Linear(32 * 4 * 2, 64)
        self.fc2 = nn.Linear(64, num_classes)
        
        print("‚úÖ –°–ø—Ä–æ—â–µ–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞:")
        print("   üîç Conv1: 1‚Üí16, —Ñ—ñ–ª—å—Ç—Ä 5x5")
        print("   üîç Conv2: 16‚Üí32, —Ñ—ñ–ª—å—Ç—Ä 3x3")
        print("   üß† FC: 256‚Üí64‚Üí4")
        
    def forward(self, x):
        x = F.relu(self.conv1(x))   # [1,64,32] ‚Üí [16,64,32]
        x = self.pool1(x)           # ‚Üí [16,16,8]
        
        x = F.relu(self.conv2(x))   # ‚Üí [32,16,8] 
        x = self.pool2(x)           # ‚Üí [32,4,2]
        
        x = x.view(x.size(0), -1)   # ‚Üí [256]
        x = F.relu(self.fc1(x))     # ‚Üí [64]
        x = self.fc2(x)             # ‚Üí [4]
        
        return x

def count_parameters(model):
    """–ü—ñ–¥—Ä–∞—Ö–æ–≤—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ –º–æ–¥–µ–ª—ñ"""
    total_params = sum(p.numel() for p in model.parameters())
    trainable_params = sum(p.numel() for p in model.parameters() if p.requires_grad)
    
    print(f"üìä –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –º–æ–¥–µ–ª—ñ:")
    print(f"   –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å: {total_params:,}")
    print(f"   –ù–∞–≤—á–∞—é—Ç—å—Å—è: {trainable_params:,}")
    print(f"   –†–æ–∑–º—ñ—Ä –º–æ–¥–µ–ª—ñ: ~{total_params * 4 / 1024:.1f} KB")
    
    return total_params

def test_model_architecture():
    """–¢–µ—Å—Ç—É—î–º–æ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É –º–æ–¥–µ–ª—ñ"""
    print("üß™ –¢–µ—Å—Ç—É—î–º–æ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä—É –º–æ–¥–µ–ª—ñ...\n")
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ (—è–∫ –∑ –Ω–∞—à–æ–≥–æ data loader)
    batch_size = 4
    test_input = torch.randn(batch_size, 1, 64, 32)
    print(f"üì• –¢–µ—Å—Ç–æ–≤–∏–π –≤—Ö—ñ–¥: {test_input.shape}")
    
    # –¢–µ—Å—Ç—É—î–º–æ –ø—Ä–æ—Å—Ç—É –º–æ–¥–µ–ª—å
    print("\n--- –ü—Ä–æ—Å—Ç–∞ CNN ---")
    model1 = SimpleCNN(num_classes=4)
    count_parameters(model1)
    
    with torch.no_grad():
        output1 = model1(test_input)
        print(f"üì§ –í–∏—Ö—ñ–¥: {output1.shape}")
        print(f"üìä –ü—Ä–∏–∫–ª–∞–¥ –ª–æ–≥—ñ—Ç—ñ–≤: {output1[0].numpy()}")
        
        # –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –≤ –π–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ 
        probabilities = F.softmax(output1[0], dim=0)
        print(f"üéØ –ô–º–æ–≤—ñ—Ä–Ω–æ—Å—Ç—ñ: {probabilities.numpy()}")
        print(f"üèÜ –ü–µ—Ä–µ–¥–±–∞—á–µ–Ω–Ω—è: –∫–ª–∞—Å {torch.argmax(output1[0]).item()}")
    
    print("\n--- –°–ø—Ä–æ—â–µ–Ω–∞ CNN ---")
    model2 = EvenSimplerCNN(num_classes=4)
    count_parameters(model2)
    
    with torch.no_grad():
        output2 = model2(test_input) 
        print(f"üì§ –í–∏—Ö—ñ–¥: {output2.shape}")
    
    print("\n‚úÖ –û–±–∏–¥–≤—ñ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –ø—Ä–∞—Ü—é—é—Ç—å!")
    return model1, model2

if __name__ == "__main__":
    print("üèóÔ∏è –¢–µ—Å—Ç—É—î–º–æ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏ –Ω–µ–π—Ä–æ–Ω–Ω–∏—Ö –º–µ—Ä–µ–∂...\n")
    
    # –¢–µ—Å—Ç—É—î–º–æ –º–æ–¥–µ–ª—ñ
    simple_model, even_simpler_model = test_model_architecture()
    
    print("\nüéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó:")
    print("   üìà SimpleCNN - –∫—Ä–∞—â–∞ —Ç–æ—á–Ω—ñ—Å—Ç—å, –±—ñ–ª—å—à–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤")
    print("   ‚ö° EvenSimplerCNN - —à–≤–∏–¥—à–µ –Ω–∞–≤—á–∞–Ω–Ω—è, –º–µ–Ω—à–µ –ø–∞–º'—è—Ç—ñ")
    print("\nüöÄ –ì–æ—Ç–æ–≤—ñ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫—Ä–æ–∫—É - –Ω–∞–≤—á–∞–Ω–Ω—è!")